<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Differential Splicing • leafcutter</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">leafcutter</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/Installation.html">Installation</a>
</li>
<li>
  <a href="../articles/Usage.html">Differential splicing</a>
</li>
<li>
  <a href="../articles/Visualization.html">Visualization</a>
</li>
<li>
  <a href="../articles/sQTL.html">SplicingQTL</a>
</li>
<li>
  <a href="../reference/index.html">R functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/davidaknowles/leafcutter">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Differential Splicing</h1>
            
          </div>

    
    
<div class="contents">
<p>For a (hopefully) complete example of the complete pipeline, take a look at</p>
<pre><code>example_data/worked_out_example.sh</code></pre>
<p>:warning: The test data download is 4Gb!</p>
<p>LeafCutter has two main components:</p>
<ol style="list-style-type: decimal">
<li>Python code to</li>
</ol>
<ul>
<li>generate intron excision counts from <code>junc</code> files (which can be obtained easily from <code>.bam</code> files)</li>
<li>group introns into clusters</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>
<code>R</code> code to</li>
</ol>
<ul>
<li>perform differential splicing (here, differential intron excision) analysis</li>
<li>plot (differentially spliced) clusters</li>
</ul>
<div id="step-0--alignment" class="section level3">
<h3 class="hasAnchor">
<a href="#step-0--alignment" class="anchor"></a>Step 0. Alignment</h3>
<p>Of course the real “Step 0” is running QC on your RNA-seq samples using e.g. <a href="http://multiqc.info/">MultiQC</a>. Assuming they look good you need to align reads. For the analysis in the LeafCutter paper we used either <a href="https://zhanglab.c2b2.columbia.edu/index.php/OLego">OLego</a>, which is designed to be particularly sensitive for finding de novo junctions, or <a href="https://github.com/alexdobin/STAR">STAR</a>, which is fast as long as you have enough RAM.</p>
<p>For <code>OLego</code> we used the command</p>
<pre><code>olego -j hg19.intron.hmr.brainmicro.bed -e 6 hg19.fa</code></pre>
<p>where <code>-j</code> provides a <a href="https://drive.google.com/open?id=0B_dRjzD1If9mR0Z6Um5LZTYxVjA">custom junction file</a>, and <code>-e</code> specifies the required number of nt the read must extend into the exon to be quantified. For more details on the junction file we used see <a href="http://genome.cshlp.org/content/25/1/1.full">Li et al. 2005</a>.</p>
<p><code>STAR</code> was run as</p>
<pre><code>STAR --runMode genomeGenerate --genomeDir hg19index/ --genomeFastaFiles hg19.fa --sjdbGTFfile gencode_v19.gtf --sjdbOverhang 100</code></pre>
<div id="choice-of-6nt-overhang" class="section level4">
<h4 class="hasAnchor">
<a href="#choice-of-6nt-overhang" class="anchor"></a>Choice of 6nt overhang</h4>
<p>We chose 6nt as the default overhang required by LeafCutter. By chance we would expect one match every 4<sup>6</sup>bp, or 4096bp, which appears to be quite likely for any given intron. However, RNA-seq mappers already deal with this problem by 1) assuring that the junction has already been previously annotated or is supported by reads with longer overhang (e.g. in STAR two-pass mode) 2) penalizing non-canonical junctions (i.e. non GT-AG junctions). The effect of the latter is that we would only expect one match every 4<sup>8</sup>bp, or 65,536bp (just one or two every 100kb, the max size allowed for our introns). However, our most restrictive filter is the requirement that reads considered be uniquely mapped. Therefore, even when the overhang is just 6bp, there is no ambiguity in mapping. Moreover, junctions are rarely only supported by reads that have an overhang of 6, when the size of the overhang goes up to 7, 8, or 9nt, the probability that we see these by chance goes down to one in over 4 million bp (for 9nt).</p>
</div>
</div>
<div id="step-1--converting-bams-to-juncs" class="section level3">
<h3 class="hasAnchor">
<a href="#step-1--converting-bams-to-juncs" class="anchor"></a>Step 1. Converting <code>bam</code>s to <code>junc</code>s</h3>
<p>I’m skipping Step 0 which would be mapping <code>fastq</code> files, e.g. using STAR, to obtain <code>.bam</code> files.</p>
<p>We provide a helper script <code>scripts/bam2junc.sh</code> to (you guessed it) convert <code>bam</code> files to <code>junc</code> files. This step uses the CIGAR strings in the <code>bam</code> to quantify the usage of each intron. LeafCutter considers a read “problematic” if its mapped cigar string does not follow the pattern ‘xMyNzM’.</p>
<p><code>example_data/worked_out_example.sh</code> gives you an example of how to do this in batch, assuming your data is in <code>run/geuvadis/</code></p>
<pre><code>for bamfile in `ls run/geuvadis/*.bam`
do
    echo Converting $bamfile to $bamfile.junc
    sh ../scripts/bam2junc.sh $bamfile $bamfile.junc
    echo $bamfile.junc &gt;&gt; test_juncfiles.txt
done</code></pre>
<p>This step is pretty fast (e.g. a couple of minutes per bam) but if you have samples numbering in the 100s you might want to do this on a cluster. Note that we also make a list of the generated <code>junc</code> files in <code>test_juncfiles.txt</code>.</p>
</div>
<div id="step-2--intron-clustering" class="section level3">
<h3 class="hasAnchor">
<a href="#step-2--intron-clustering" class="anchor"></a>Step 2. Intron clustering</h3>
<p>Next we need to define intron clusters using the <code>leafcutter_cluster.py</code> script. For example:</p>
<pre><code>python ../clustering/leafcutter_cluster.py -j test_juncfiles.txt -m 50 -o testYRIvsEU -l 500000</code></pre>
<p>This will cluster together the introns fond in the <code>junc</code> files listed in <code>test_juncfiles.txt</code>, requiring 50 split reads supporting each cluster and allowing introns of up to 500kb. The predix <code>testYRIvsEU</code> means the output will be called <code>testYRIvsEU_perind_numers.counts.gz</code> (perind meaning these are the <em>per individual</em> counts).</p>
<p>You can quickly check what’s in that file with</p>
<pre><code>zcat testYRIvsEU_perind_numers.counts.gz | more </code></pre>
<p>which should look something like this:</p>
<pre><code>RNA.NA06986_CEU.chr1.bam RNA.NA06994_CEU.chr1.bam RNA.NA18486_YRI.chr1.bam RNA.NA06985_CEU.chr1.bam RNA.NA18487_YRI.chr1.bam RNA.NA06989_CEU.chr1.bam RNA.NA06984_CEU.chr1.bam RNA.NA18488_YRI.chr1.bam RNA.NA18489_YRI.chr1.bam RNA.NA18498_YRI.chr1.bam
chr1:17055:17233:clu_1 21 13 18 20 17 12 11 8 15 25
chr1:17055:17606:clu_1 4 11 12 7 2 0 5 2 4 4
chr1:17368:17606:clu_1 127 132 128 55 93 90 68 43 112 137
chr1:668593:668687:clu_2 3 11 1 3 4 4 8 1 5 16
chr1:668593:672093:clu_2 11 16 23 10 3 20 9 6 23 31</code></pre>
<p>Each column corresponds to a different sample (original bam file) and each row to an intron, which are identified as chromosome:intron_start:intron_end:cluster_id.</p>
</div>
<div id="step-3--differential-intron-excision-analysis" class="section level3">
<h3 class="hasAnchor">
<a href="#step-3--differential-intron-excision-analysis" class="anchor"></a>Step 3. Differential intron excision analysis</h3>
<p>We can now use our nice intron count file to do differential splicing (DS) analysis, but first we need to make a file to specify which samples go in each group. In <code>worked_out_example.sh</code> there’s some code to generate this file, but you can just make it yourself: it’s just a two column tab-separated file where the first column is the sample name (i.e. the filename of the ‘bam’) and the second is the column (what you call these is arbitrary, but note :bug: the command line interface currently only supports two groups).</p>
<p>For the worked example this file, named <code>test_diff_introns.txt</code> looks like this:</p>
<pre><code>RNA.NA18486_YRI.chr1.bam YRI
RNA.NA18487_YRI.chr1.bam YRI
RNA.NA18488_YRI.chr1.bam YRI
RNA.NA18489_YRI.chr1.bam YRI
RNA.NA18498_YRI.chr1.bam YRI
RNA.NA06984_CEU.chr1.bam CEU
RNA.NA06985_CEU.chr1.bam CEU
RNA.NA06986_CEU.chr1.bam CEU
RNA.NA06989_CEU.chr1.bam CEU
RNA.NA06994_CEU.chr1.bam CEU</code></pre>
<p>Having made that file we can run DS (this assumes you have successfully installed the <code>leafcutter</code> R package as described under Installation above)</p>
<pre><code>../scripts/leafcutter_ds.R --num_threads 4 ../example_data/testYRIvsEU_perind_numers.counts.gz ../example_data/test_diff_intron.txt</code></pre>
<p>Running <code>../scripts/leafcutter_ds.R -h</code> will give usage info for this script.</p>
<p>Two tab-separated text files are output:</p>
<ul>
<li>
<code>leafcutter_ds_cluster_significance.txt</code>. This shows per cluster <code>p</code>-values for there being differential intron excision between the two groups tested. The columns are</li>
</ul>
<ol style="list-style-type: decimal">
<li>cluster: the cluster id</li>
<li>Status: whether this cluster was a) successfully tested b) not tested for some reason (e.g. too many introns) c) there was an error during testing - this should be rare.</li>
<li>loglr: log likelihood ratio between the null model (no difference between the groups) and alternative (there is a difference)</li>
<li>df: degrees of freedom, equal to the number of introns in the cluster minus one (assuming two groups)</li>
<li>p: the resulting (unadjusted!) p-value under the asymptotic Chi-squared distribution. We just use <code>p.adjust( ..., method="fdr")</code> in R to control FDR based on these.</li>
</ol>
<ul>
<li>
<code>leafcutter_ds_effect_sizes.txt</code>. This shows per intron effect sizes between the groups, with columns:</li>
</ul>
<ol style="list-style-type: decimal">
<li>intron: this has the form chromosome:intron_start:intron_end:cluster_id</li>
<li>log effect size (as fitted by LeafCutter).</li>
<li>Fitted usage proportion in condition 1.</li>
<li>Fitted usage proportion in condition 2.</li>
<li>DeltaPSI: the difference in usage proprotion (condition 2 - condition 1). Note that in general this will have the same sign as the log effect size but in some cases the sign may change as a result of larger changes for other introns in the cluster.</li>
</ol>
<div id="including-confounders" class="section level4">
<h4 class="hasAnchor">
<a href="#including-confounders" class="anchor"></a>Including confounders</h4>
<p>To control for confounders/covariates (e.g. batch, RIN) in the DS you can include them as additional columns in the test_diff_introns.txt file, after the sample names and two-group factor to be tested. Numeric values will be treated as such, so use non-numeric values if you want a categorical variable/factor, e.g. batch1, batch2 etc.</p>
</div>
<div id="calibration-fdr-and-small-sample-sizes" class="section level4">
<h4 class="hasAnchor">
<a href="#calibration-fdr-and-small-sample-sizes" class="anchor"></a>Calibration, FDR and small sample sizes</h4>
<p>The Benjamini-Hochberg FDR control we use assumes p-values are well-calibrated, i.e. under the null hypothesis of no difference between conditions p-values are truly uniformly distributed. Our experiments suggest that at least down to 4 vs. 4 comparisons LeafCutter remains well calibrated. For example, the qq plot for 4 brain vs 4 muscle from the LeafCutter paper:</p>
<div class="figure">
<img src="calibration_4v4.png">
</div>
<p>Proceed with caution if you have fewer than 4 samples per group. Such analyses can be performed changing the <code>-i</code> (minimum samples per intron) and <code>-g</code> (minimum samples per group) options in <code>leafcutter_ds.R</code>, e.g. <code>-i 4 -g 2</code> for 2 versus 2 comparisons (default is currently <code>-i 5 -g 3</code>). In principle you could even do 1 vs. 1 comparisons, further discussion (here)[<a href="https://github.com/davidaknowles/leafcutter/issues/5" class="uri">https://github.com/davidaknowles/leafcutter/issues/5</a>].</p>
<p>If the precision of the FDR estimates are particularly important for your application it may be worth considering performing a permutation analysis. Currently you need to do this manually (e.g. by permuting the labeling in your groups_file) but if there is demand we’ll consider implementing permutations as a built-in feature. Note that in general permutation analysis doesn’t allow you to include confounders.</p>
</div>
</div>
<div id="step-4--plotting-splice-junctions" class="section level3">
<h3 class="hasAnchor">
<a href="#step-4--plotting-splice-junctions" class="anchor"></a>Step 4. Plotting splice junctions</h3>
<p>This will make a pdf with plots of the differentially spliced clusters detected at an FDR of 5%.</p>
<pre><code>../scripts/ds_plots.R -e ../leafcutter/data/gencode19_exons.txt.gz ../example_data/testYRIvsEU_perind_numers.counts.gz ../example_data/test_diff_intron.txt leafcutter_ds_cluster_significance.txt -f 0.05</code></pre>
<p>We now have a LeafCutter shiny app allowing interactive visual interrogation of your results, go to the <a href="./Visualization.html">Visualization</a> tab to learn how to feed the LeafCutter output into the shiny app.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by David Knowles, Yang Li, Jack Humphrey, Jonathan Pritchard.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
